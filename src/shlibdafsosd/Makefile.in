# API version. When something changes, increment as appropriate. 
# Ignore at your own risk.
LIBAFSRPCMAJOR=0

# Copyright 2000, International Business Machines Corporation and others.
# All Rights Reserved.
# 
# This software has been released under the terms of the IBM Public
# License.  For details, see the LICENSE file in the top-level source
# directory or online at http://www.openafs.org/dl/license10.html
#
# Portions Copyright (c) 2003 Apple Computer, Inc.

# This is a pthread safe library containing rx, rxkad and des.

srcdir=@srcdir@
include @TOP_OBJDIR@/src/config/Makefile.config
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_SCRIPT = @INSTALL_SCRIPT@

LIBAFSRPCMINOR=`grep LIBAFSOSD_VERSION ${TOP_INCDIR}/afs/afsosd.h | /usr/bin/awk '{print $$3}'`

CC=${MT_CC}
CFLAGS = ${COMMON_CFLAGS} -DRXDEBUG ${MT_CFLAGS} ${SHLIB_CFLAGS} -DAFS_DEMAND_ATTACH_FS
SFLAGS=-P -I${TOP_INCDIR}

CCRULE = ${CC} ${CFLAGS} -DBUILD_SHLIBAFSOSD -c $?
CCRULE2 = ${CC} ${CFLAGS} -DBUILD_SHLIBAFSOSD -c $<
CCRULESALV = ${CC} ${CFLAGS} -DBUILD_SHLIBAFSOSD -DBUILD_SALVAGER -o vol_osd_salv.o -c $?

OSDDB = ${srcdir}/../osddb
VOL = ${srcdir}/../vol
VOLOBJ = ../vol
VOLSER = ${srcdir}/../volser
VOLSEROBJ = ../volser
FSINT = ${srcdir}/../fsint
VICED = ${srcdir}/../viced
RXOSD = ${srcdir}/../rxosd

RXOSDOBJS = \
	rxosd.cs.o \
	rxosd.xdr.o

OSDDBOBJS =\
	osddb.cs.o \
	osddb.xdr.o \
	osddbuser.o \
	osddb.ss.o \
	osddbprocs.o

VOLOBJS = \
	vol_osd.o \
	vol_osd_salv.o \
	vol_osd.xdr.o \
	libafsosd.o 

VICDEOBJS = \
	afsosdprocs.o

VOLSEROBJS = \
	volosdprocs.o \
	volint.xdr.o \
	volosdint.ss.o \
	volosdint.cs.o \
	volosdint.xdr.o

FSINTOBJS = \
	afsosdint.ss.o \
	afsosdint.xdr.o

VICEDOBJS = \
	afsosdprocs.o

LIBOBJS = \
	${OSDDBOBJS} \
	${RXOSDOBJS} \
	${VOLOBJS} \
	${VICEDOBJS} \
	${VOLSEROBJS} \
	${FSINTOBJS}

LIBAFSOSD = libdafsosd.${SHLIB_SUFFIX}.${LIBAFSRPCMAJOR}.${LIBAFSRPCMINOR}

all: ${TOP_LIBDIR}/${LIBAFSOSD} ${TOP_LIBDIR}/libdafsosd_pic.a

${TOP_LIBDIR}/${LIBAFSOSD}: ${LIBAFSOSD}
	../config/shlib-install -d ${TOP_LIBDIR} \
		-l libdafsosd -M ${LIBAFSRPCMAJOR} -m ${LIBAFSRPCMINOR}

${TOP_LIBDIR}/libdafsosd_pic.a: libdafsosd_pic.a
	${INSTALL_DATA} libdafsosd_pic.a $@

install: ${LIBAFSOSD} libdafsosd_pic.a
	../config/shlib-install -d ${DESTDIR}${libdir} \
		-l libdafsosd -M ${LIBAFSRPCMAJOR} -m ${LIBAFSRPCMINOR}
	${INSTALL_DATA} libdafsosd_pic.a ${DESTDIR}${libdir}/libdafsosd_pic.a

dest: ${LIBAFSOSD} libdafsosd_pic.a
	../config/shlib-install -d ${DEST}/lib \
		-l libdafsosd -M ${LIBAFSRPCMAJOR} -m ${LIBAFSRPCMINOR}
	${INSTALL_DATA} libdafsosd_pic.a ${DEST}/lib/libdafsosd_pic.a

${LIBAFSOSD}: ${LIBOBJS} libdafsosd.map
	../config/shlib-build -d $(srcdir) -l libdafsosd \
		-M ${LIBAFSRPCMAJOR} -m ${LIBAFSRPCMINOR} -- \
		${LIBOBJS} ${MT_LIBS}

libdafsosd_pic.a: ${LIBOBJS}
	$(RM) -f $@
	$(AR) crv $@ ${LIBOBJS}
	$(RANLIB) $@

# vol routines

vol_osd.o: ${VOL}/vol_osd.c
	${CCRULE}

vol_osd.xdr.o: ${VOLOBJ}/vol_osd.xdr.c
	${CCRULE}

libafsosd.o: ${VOL}/libafsosd.c
	${CCRULE}

# osddb routines

osddb.h: ${OSDDB}/osddb.xg
	${RXGEN} -A -x -h -o $@ ${OSDDB}/osddb.xg

osddb.cs.c: ${OSDDB}/osddb.xg
	${RXGEN} -A -x -C -o $@ ${OSDDB}/osddb.xg

osddb.ss.c: ${OSDDB}/osddb.xg
	${RXGEN} -A -x -S -o $@ ${OSDDB}/osddb.xg

osddb.xdr.c: ${OSDDB}/osddb.xg
	${RXGEN} -A -x -c -o $@ ${OSDDB}/osddb.xg

osddbuser.o: ${OSDDB}/osddbuser.c
	${CCRULE}

osddb.xdr.o: osddb.xdr.c osddb.h
	${CCRULE2}

osddb.cs.o: osddb.cs.c osddb.h
	${CCRULE2}

osddb.ss.o: osddb.ss.c osddb.h
	${CCRULE2}

osddbprocs.o: ${OSDDB}/osddbprocs.c
	${CCRULE}

# rxosd stuff

rxosd.h: ${RXOSD}/rxosd.xg
	${RXGEN} -A -x -h -o $@ ${RXOSD}/rxosd.xg

rxosd.cs.c: ${RXOSD}/rxosd.xg
	${RXGEN} -A -x -C -o $@ ${RXOSD}/rxosd.xg

rxosd.xdr.c: ${RXOSD}/rxosd.xg
	${RXGEN} -A -x -c -o $@ ${RXOSD}/rxosd.xg

rxosd.cs.o: rxosd.cs.c rxosd.h
	${CCRULE2}

rxosd.xdr.o: rxosd.xdr.c rxosd.h
	${CCRULE2}

# salvager stuff

vol_osd_salv.o: ${VOL}/vol_osd.c
	${CCRULESALV}

# fileserver stuff

afsint.h: ${FSINT}/afsint.xg
	${RXGEN} -A -x -h -o $@ ${FSINT}/afsint.xg

afsosdint.h: ${FSINT}/afsosdint.xg
	${RXGEN} -A -x -h -o $@ ${FSINT}/afsosdint.xg

afsosdint.ss.c: ${FSINT}/afsosdint.xg
	${RXGEN} -A -x -S -o $@ ${FSINT}/afsosdint.xg

afsosdint.xdr.c: ${FSINT}/afsosdint.xg
	${RXGEN} -A -x -c -o $@ ${FSINT}/afsosdint.xg

afsosdint.xdr.o: afsosdint.xdr.c afsosdint.h afsint.h
	${CCRULE2}

afsosdint.ss.o: afsosdint.ss.c afsosdint.h afsint.h
	${CCRULE2}

afsosdprocs.o: ${VICED}/afsosdprocs.c
	${CCRULE}

# volserver stuff

volint.h: ${VOLSER}/volint.xg
	${RXGEN} -A -x -h -o $@ ${VOLSER}/volint.xg

volosdint.h: ${VOLSER}/volosdint.xg
	${RXGEN} -A -x -h -o $@ ${VOLSER}/volosdint.xg

volosdint.ss.c: ${VOLSER}/volosdint.xg
	${RXGEN} -A -x -S -o $@ ${VOLSER}/volosdint.xg

volosdint.cs.c: ${VOLSER}/volosdint.xg
	${RXGEN} -A -x -C -o $@ ${VOLSER}/volosdint.xg

volosdint.xdr.c: ${VOLSER}/volosdint.xg
	${RXGEN} -A -x -c -o $@ ${VOLSER}/volosdint.xg

volosdint.ss.o: volosdint.ss.c volosdint.h volint.h
	${CCRULE2}

volosdint.cs.o: volosdint.cs.c volosdint.h volint.h
	${CCRULE2}

volosdint.xdr.o: volosdint.xdr.c volosdint.h
	${CCRULE2}

volint.xdr.o: ../volser/volint.xdr.c volint.h
	${CCRULE2}

volosdprocs.o: ${VOLSER}/volosdprocs.c
	${CCRULE}

clean:
	$(RM) -f *.o libdafsosd.a* libdafsosd.sl* libdafsosd.so* \
		 *.c *.h *.gch \
		libdafsosd_pic.a libdafsosd.dylib.* libdafsosd.exp
