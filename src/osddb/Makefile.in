
srcdir=@srcdir@
include @TOP_OBJDIR@/src/config/Makefile.config
INSTALL = /usr/bin/install -c

CCRULE=${CC} ${CFLAGS} -c $?

LIBS =	${TOP_LIBDIR}/libubik.a \
		${TOP_LIBDIR}/libauth.a \
		${TOP_LIBDIR}/libaudit.a \
		${TOP_LIBDIR}/librxkad.a \
		${TOP_LIBDIR}/librxstat.a \
		${TOP_LIBDIR}/librx.a \
		${TOP_LIBDIR}/libcmd.a \
		${TOP_LIBDIR}/liblwp.a \
		${TOP_LIBDIR}/libdes.a \
		${TOP_LIBDIR}/libafscom_err.a \
		${TOP_LIBDIR}/util.a \
		${TOP_LIBDIR}/libsys.a 

SRCS = ${srcdir}/*.c


########## Targets ############

dest: all ${DEST}/root.server/usr/afs/bin/osddbserver \
	${DEST}/root.server/usr/afs/bin/archiver \
	${DEST}/root.server/usr/afs/bin/archive1 \
	${DEST}/root.server/usr/afs/bin/wiper

all: osddbserver osddbuser.o ${TOP_INCDIR}/afs/osddbuser.h \
	${TOP_INCDIR}/afs/osddb.h osddb.cs.o osddb.xdr.o \
	${TOP_LIBDIR}/libosddb.a test

osddb.h: ${srcdir}/osddb.xg
	${RXGEN} -x -h -o $@ ${srcdir}/osddb.xg

osddb.cs.c: ${srcdir}/osddb.xg
	${RXGEN} -x -C -o $@ ${srcdir}/osddb.xg

osddb.ss.c: ${srcdir}/osddb.xg
	${RXGEN} -x -S -o $@ ${srcdir}/osddb.xg

osddb.xdr.c: ${srcdir}/osddb.xg
	${RXGEN} -x -c -o $@ ${srcdir}/osddb.xg

volint.h: ${srcdir}/../volser/volint.xg
	${RXGEN} -x -h -o $@ ${srcdir}/../volser/volint.xg


osddbserver.o: ${srcdir}/osddbserver.c osddb.h
	${CC} ${CFLAGS} -o osddbserver.o -c ${srcdir}/osddbserver.c

osddbserver: osddbserver.o osddb.ss.o osddb.xdr.o ${LIBS} Makefile
	${CC} ${CFLAGS} -o osddbserver osddbserver.o osddb.ss.o osddb.xdr.o  ${LIBS} ${XLIBS}


osddbuser.o: ${srcdir}/osddbuser.c osddb.h volint.h ${TOP_INCDIR}/afs/afsosd.h
	${CC} ${CFLAGS} -I${srcdir}/../ -o osddbuser.o -c ${srcdir}/osddbuser.c

libosddb.a: osddb.cs.o osddb.xdr.o osddbuser.o
	${RM} -f $@
	${AR} cvr $@ osddb.cs.o osddb.xdr.o osddbuser.o
	${RANLIB} $@

test.o: ${srcdir}/test.c osddb.h
	${CC} ${CFLAGS} -o test.o -c ${srcdir}/test.c

test: test.o osddbuser.o libosddb.a 
	${CC} ${CFLAGS} -o test test.o osddbuser.o osddb.cs.o osddb.xdr.o ${LIBS} ${XLIBS}

${DEST}/root.server/usr/afs/bin/osddbserver: osddbserver 
	${INSTALL} $? $@

${DEST}/root.server/usr/afs/bin/archiver: ${srcdir}/archiver 
	${CP} ${srcdir}/archiver ${DEST}/root.server/usr/afs/bin/archiver

${DEST}/root.server/usr/afs/bin/archive1: ${srcdir}/archive1 
	${CP} ${srcdir}/archive1 ${DEST}/root.server/usr/afs/bin/archive1

${DEST}/root.server/usr/afs/bin/wiper: ${srcdir}/wiper 
	${CP} ${srcdir}/wiper ${DEST}/root.server/usr/afs/bin/wiper

${DESTDIR}${afssrvlibexecdir}/osddbserver: osddbserver
	${INSTALL} $? $@

${DESTDIR}${afssrvlibexecdir}/archiver: ${srcdir}/archiver
	${CP} ${srcdir}/archiver ${DESTDIR}${afssrvlibexecdir}/archiver

${DESTDIR}${afssrvlibexecdir}/archive1: ${srcdir}/archive1
	${CP} ${srcdir}/archive1 ${DESTDIR}${afssrvlibexecdir}/archive1

${DESTDIR}${afssrvlibexecdir}/wiper: ${srcdir}/wiper
	${CP} ${srcdir}/wiper ${DESTDIR}${afssrvlibexecdir}/wiper

${TOP_INCDIR}/afs/osddb.h: osddb.h
	${INSTALL} $? $@

${TOP_INCDIR}/afs/afsosd.h: ${srcdir}/../vol/afsosd.h
	${INSTALL} $? $@

${TOP_INCDIR}/afs/osddbuser.h: osddbuser.h
	${INSTALL} $? $@

${DESTDIR}${includedir}/afs/osddb.h: osddb.h
	${INSTALL} $? $@

${TOP_LIBDIR}/libosddb.a: libosddb.a
	${INSTALL} $? $@

depend: osddb.h
	makedepend ${INCLUDE} ${SRCS}

distclean: clean

clean:
	$(RM) -f osddb.xdr.c osddb.ss.c osddb.h osddb.cs.c *.o *~ osddbserver
	$(RM) -f test volint.h


#
# Installation targets
#
install: \
	all \
	${DESTDIR}${afssrvlibexecdir}/osddbserver \
	${DESTDIR}${afssrvlibexecdir}/archiver \
	${DESTDIR}${afssrvlibexecdir}/archive1 \
	${DESTDIR}${afssrvlibexecdir}/wiper \
	${DESTDIR}${includedir}/afs/osddb.h

dest: \
	all \
	${DEST}/root.server/usr/afs/bin/osddbserver \
	${TOP_INCDIR}/afs/osddb.h

########## Static Dependencies ############

osddb.cs.o: osddb.cs.c osddb.h
osddb.ss.o: osddb.ss.c osddb.h
osddb.xdr.o: osddb.xdr.c osddb.h


